<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>BHW Dashboard</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<link href="https://fonts.googleapis.com" rel="preconnect"/>
<link crossorigin="" href="https://fonts.gstatic.com" rel="preconnect"/>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&amp;family=Lato:wght@300;400;700&amp;display=swap" rel="stylesheet"/>
<script id="tailwind-config">
tailwind.config = {
  darkMode: "class",
  theme: {
    extend: {
      colors: {
        "primary": "#90EE90",
        "secondary": "#43A047",
        "accent": "#A5D6A7",
        "background-light": "#F9FAFB", // Gray-50
        "background-dark": "#1F2937", // Gray-800
        "text-light": "#1B5E20", // Green-800
        "text-dark": "#F9FAFB", // Gray-50
      },
      fontFamily: {
        "display": ["Roboto", "sans-serif"],
        "body": ["Lato", "sans-serif"]
      },
      borderRadius: {
        "DEFAULT": "0.5rem",
        "lg": "0.75rem",
        "xl": "1rem",
        "full": "9999px"
      },
    },
  },
}
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link rel="stylesheet" href="css/style.css">
<style>
nav button.active { text-decoration: underline; }
</style>
<style>
/* Dashboard Header */
.dashboard-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
}
.dashboard-header h2 { margin: 0; }
.dashboard-actions .btn { margin-left: 10px; }

.header-actions {
  display: flex;
  gap: 10px;
  align-items: center;
}

/* Search Section */
.search-section {
  display: flex;
  gap: 10px;
  align-items: center;
}

/* Expandable Search */
.search-container.expandable {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  border: 1px solid #e5e7eb;
  background: #fff;
  border-radius: 999px;
  padding: 6px 10px;
  transition: box-shadow .2s ease, border-color .2s ease;
}
.search-container.expandable:focus-within {
  border-color: #1E88E5;
  box-shadow: 0 0 0 4px rgba(30,136,229,.15);
}
.search-container.expandable .icon-button {
  appearance: none;
  border: none;
  background: transparent;
  cursor: pointer;
  font-size: 16px;
  line-height: 1;
}
.search-container.expandable .search-input {
  width: 0;
  opacity: 0;
  border: none;
  outline: none;
  font-size: 14px;
  transition: width .25s ease, opacity .2s ease;
}
.search-container.expandable.open .search-input {
  width: 220px;
  opacity: 1;
}
@media (max-width: 720px) {
  .search-container.expandable.open .search-input { width: 160px; }
}

/* Toolbar */
.toolbar {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
  align-items: center;
}

/* Action buttons */
.action-btn {
  padding: 2px 8px;
  font-size: 0.9em;
  margin-right: 5px;
  border-radius: 3px;
  border: none;
  cursor: pointer;
}
.edit-btn { background-color: #f39c12; color: white; }
.edit-btn.active { background-color: #28a745; color: white; }
.delete-btn { background-color: #e74c3c; color: white; }

/* Vaccine buttons */
.vaccine-btn {
  font-size: 12px;
  padding: 3px 8px;
}
.badge.vaccinated { background-color: #22c55e; color: #fff; padding: 2px 6px; border-radius: 3px; font-size: 12px; }
.badge.not-vaccinated { background-color: #fbbf24; color: #000; padding: 2px 6px; border-radius: 3px; font-size: 12px; }



/* Table & UI */
.table-container {
  max-height: 450px;
  overflow-y: auto;
  border: 1px solid #ccc;
  margin-top: 10px;
}
.table-container table {
  font-size: 14px;
  border-collapse: collapse;
  width: 100%;
}
.table-container th,
.table-container td {
  padding: 6px 8px;
  white-space: nowrap;
  text-align: left;
  border-bottom: 1px solid #ddd;
  border-right: 1px solid #ddd;
  font-size: 14px;
}
.table-container th {
  background-color: #e9ecef;
  color: #000;
}

.new-child { background-color: #d0e7ff; } /* highlight for new children */

.search-container { position: relative; display: inline-block; }
.search-icon { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); pointer-events: none; color: #999; }

.dropdown { position: relative; display: inline-block; }
.dropdown-content { display: none; position: absolute; background-color: #f9f9f9; min-width: 160px; box-shadow: 0px 8px 16px 0px rgba(0,0,0,0.2); z-index: 1; top: 100%; left: 0; }
.dropdown.active .dropdown-content { display: block; }
.dropdown-content .btn { display: block; width: 100%; text-align: left; padding: 8px 16px; border: none; background: none; cursor: pointer; }
.dropdown-content .btn:hover { background-color: #f1f1f1; }

/* Upbar (Top Navigation) */
.upbar {
  width: 100%;
  background: #90EE90;
  color: #000;
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 0 24px;
  position: sticky;
  top: 0;
  z-index: 1000;
  height: 68px;
}
.upbar .brand { display: flex; align-items: center; font-size: 20px; font-weight: bold; }
.upbar .brand img { height: 40px; margin-right: 8px; }
.upbar nav { display: flex; gap: 1rem; align-items: center; }
.upbar .upbar-btn { background: none; border: none; color: white; font-size: 16px; cursor: pointer; padding: 10px 14px; border-radius: 4px; }
.upbar .upbar-btn:hover, .upbar .upbar-btn.active { background: #0056b3; }
.upbar a { background: #dc3545; color: white; text-decoration: none; padding: 10px 14px; border-radius: 4px; }
.upbar a:hover { background: #a71d2a; }

/* Logout Modal */
.modal { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); }
.modal-content { background-color: #fff; margin: 15% auto; padding: 20px; border: 1px solid #888; width: 90%; max-width: 400px; text-align: center; border-radius: 8px; }
.modal-content p { margin-bottom: 20px; }
.modal-content button { margin: 0 10px; padding: 10px 20px; border: none; border-radius: 4px; cursor: pointer; }
#confirmLogout { background: #dc3545; color: white; }
#cancelLogout { background: #6c757d; color: white; }

.tab-btn { cursor:pointer; margin-right:10px; padding:5px 10px; }
.tab-btn.active { text-decoration: underline; }
.tab-content { display:none; }
.tab-content.active { display:block; }

</style>
</head>
<body class="bg-background-light dark:bg-background-dark font-body text-text-light dark:text-text-dark">
<header class="flex items-center justify-between whitespace-nowrap bg-primary px-6 py-4 shadow-md sticky top-0 z-50">
  <div class="flex items-center gap-2 sm:gap-4 text-text-light dark:text-text-dark">
    <span class="material-symbols-outlined text-3xl sm:text-4xl text-primary">health_and_safety</span>
    <h2 class="text-xl sm:text-2xl font-bold leading-tight tracking-[-0.015em] font-display">BHW Dashboard</h2>
  </div>
  <nav class="flex items-center gap-4">
    <button class="text-lg font-medium leading-normal hover:text-primary transition-colors" onclick="openTab('aboutTab', this)">Home</button>
    <button class="text-lg font-medium leading-normal hover:text-primary transition-colors active" onclick="openTab('childrenTab', this)">Children Records</button>
    <button class="text-lg font-medium leading-normal hover:text-primary transition-colors" onclick="openTab('profileTab', this)">Profile</button>
    <button onclick="logout()" class="flex min-w-[84px] max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-lg h-10 px-4 sm:h-12 sm:px-6 bg-primary text-white text-sm sm:text-base font-bold leading-normal tracking-[0.015em] hover:bg-primary/90 transition-opacity">
      <span class="truncate">Logout</span>
    </button>
  </nav>
</header>

<main class="container max-w-full mx-auto px-20 py-8">
  <div id="childrenTab" class="tab-content active">
  <div class="dashboard-header">
    <div class="header-actions ml-auto">
      <div class="flex gap-2 items-center">
        <input type="text" id="searchName" placeholder="Search by name" class="w-64 px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary focus:outline-none">
        <button id="searchBtn" class="bg-primary text-white px-4 py-2 rounded-md hover:bg-secondary transition">Search</button>
        <div class="relative inline-block">
          <button class="btn bg-white border border-gray-300 rounded-md px-4 py-2" onclick="toggleFilterDropdown()">Filter ▼</button>
          <div class="filter-bar" id="filterBar" style="display:none; position: absolute; right: 0; z-index: 20;">
            <div class="bg-white shadow-md p-4 rounded-lg mt-2 relative">
              <button onclick="toggleFilterDropdown()" class="absolute top-2 right-3 text-gray-500 hover:text-gray-800 text-2xl leading-none">&times;</button>
              <div class="flex gap-6 items-start">
                <div>
                  <h4 class="font-medium text-sm mb-2 border-b">Year</h4>
                  <div id="yearFilterContainer" class="space-y-1 max-h-80 overflow-y-auto pr-2">
                    <!-- Year checkboxes will be populated by JS -->
                  </div>
                </div>
                <div>
                  <h4 class="font-medium text-sm mb-2 border-b">Month</h4>
                  <div id="monthFilterContainer" class="space-y-1 max-h-80 overflow-y-auto pr-2">
                    <!-- Month checkboxes will be populated by JS -->
                  </div>
                </div>
              </div>
              <div class="flex gap-3 items-center mt-4">
                <button onclick="applyFilter()" class="bg-primary text-white px-3 py-1 text-sm rounded-md hover:bg-secondary transition">Apply</button>
                <button onclick="clearFilter()" class="bg-gray-500 text-white px-3 py-1 text-sm rounded-md hover:bg-gray-600 transition">Clear</button>
              </div>
            </div>
          </div>
        </div>
        <div class="dropdown">
          <button class="btn bg-white border border-gray-300 rounded-md px-4 py-2" onclick="toggleDownloadDropdown()">Download Data ▼</button>
          <div class="dropdown-content">
            <button class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100" onclick="downloadData('csv')">Download as CSV</button>
            <button class="w-full text-left px-4 py-2 text-sm hover:bg-gray-100" onclick="downloadData('excel')">Download as Excel</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="toolbar mt-4">
    <input type="file" id="fileInput" class="input" accept=".csv,.xlsx,.xls" style="display:none;">
    <button class="btn border border-gray-300 rounded-md px-4 py-2" onclick="openUploadModal()">Upload File</button>
    <button class="btn border border-gray-300 rounded-md px-4 py-2" id="editBtn" onclick="toggleEditMode()">Edit</button>
    <div id="editModeActions" style="display: none;" class="flex items-center gap-2 ml-2">
        <button class="btn bg-white border border-gray-300 rounded-md px-4 py-2 text-sm" onclick="confirmAddChild()">+ Add Child</button>
        <button class="btn bg-white border border-gray-300 rounded-md px-4 py-2 text-sm" onclick="deleteSelected()">Delete Selected</button>
        <button class="btn bg-white border border-gray-300 rounded-md px-4 py-2 text-sm" onclick="saveTableEdits()">Save Changes</button>
    </div>
  </div>

  <h3 id="reportDateTitle" class="text-xl font-semibold mt-6 mb-2" style="display: none;"></h3>

  <div class="table-container">
      <table class="table" id="childrenTable">
        <thead>
          <tr>
            <th><input type="checkbox" id="selectAll" onchange="toggleSelectAll(this)"></th><th>Name of Children</th><th>Age in Months</th><th>Date of Birth</th><th>Name of Parent</th><th>Report Date</th>
    <th>BCG (At Birth)</th><th>HEPA B (At Birth)</th><th>PENTA 1 ( 1 1/2 mos.)</th><th>PENTA 2 ( 2 1/2 mos.)</th><th>PENTA 3 ( 3 1/2 mos.)</th>
    <th>OPV 1  ( 1 1/2 mos.)</th><th>OPV 2  ( 2 1/2 mos.)</th><th>OPV 3  ( 3 1/2 mos.)</th><th>IPV1  ( 3 1/2 mos.)</th><th>IPV2  ( 9 mos.)</th>
    <th>PCV1  ( 1 1/2 mos.)</th><th>PCV2  ( 2 1/2 mos.)</th><th>PCV3  ( 3 1/2 mos.)</th><th>MCV1 (9 mos.)</th><th>MCV2 (12 mos. & 29 days)</th>
          </tr>
        </thead>
      <tbody></tbody>
    </table>
  </div>

  <p id="noRecords" style="display:none;">No records yet.</p>
  </div>

  <div id="aboutTab" class="tab-content">
    <h3>About the BHW Dashboard</h3>
    <p>This dashboard allows Barangay Health Workers to monitor and manage child immunization records in their assigned barangay and sector.</p>
    <p>Features:</p>
    <ul>
      <li>View and edit children records</li>
      <li>Upload data from CSV or Excel files</li>
      <li>Export reports to CSV or Excel</li>
      <li>Search and filter records</li>
    </ul>
  </div>

  <div id="profileTab" class="tab-content">
    <div class="bhw-profile-section mb-8 p-6 bg-gray-50 rounded-lg">
      <h3 class="text-lg font-semibold mb-4">Your Profile (BHW)</h3>
      <div id="bhwProfileInfo" class="grid grid-cols-1 md:grid-cols-2 gap-4">
        <p><strong>Name:</strong> <span id="bhwName">Loading...</span></p>
        <p><strong>Email:</strong> <span id="bhwEmail">Loading...</span></p>
        <p><strong>Barangay:</strong> <span id="bhwBarangay">Loading...</span></p>
        <p><strong>Sector:</strong> <span id="bhwSector">Loading...</span></p>
      </div>
    </div>
  </div>
</main>

<!-- Upload Modal -->
<div id="uploadModal" class="modal">
  <div class="modal-content">
    <h3 class="text-lg font-semibold mb-4">Select Report Period</h3>
    <p class="text-sm text-gray-600 mb-4">Please select the month and year this report corresponds to.</p>
    <div class="grid grid-cols-2 gap-4 mb-6">
      <div>
        <label for="reportYearSelect" class="block text-sm font-medium text-left mb-1">Year:</label>
        <select id="reportYearSelect" class="w-full p-2 border border-gray-300 rounded-md"></select>
      </div>
      <div>
        <label for="reportMonthSelect" class="block text-sm font-medium text-left mb-1">Month:</label>
        <select id="reportMonthSelect" class="w-full p-2 border border-gray-300 rounded-md"></select>
      </div>
    </div>
    <div id="uploadWarning" class="text-sm text-amber-600 bg-amber-100 p-3 rounded-md mb-4" style="display: none;"></div>
    <div>
      <button id="proceedUploadBtn" class="bg-primary text-white px-6 py-2 rounded-md hover:bg-secondary transition">Proceed</button>
      <button onclick="closeUploadModal()" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600 transition">Cancel</button>
    </div>
  </div>
</div>

<!-- Success/Info Modal -->
<div id="infoModal" class="modal">
    <div class="modal-content">
        <p id="infoModalText" class="mb-4"></p>
        <button onclick="document.getElementById('infoModal').style.display = 'none'" class="bg-primary text-white px-6 py-2 rounded-md hover:bg-secondary">OK</button>
    </div>
</div>

<!-- Unsaved Changes Confirmation Modal -->
<div id="confirmCancelModal" class="modal">
  <div class="modal-content">
    <p id="confirmCancelText"></p>
    <div class="mt-4">
      <button id="confirmCancelBtn" class="bg-red-500 text-white px-6 py-2 rounded-md hover:bg-red-600">Yes, Proceed</button>
      <button id="cancelActionBtn" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600">No, Go Back</button>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div id="confirmDeleteModal" class="modal">
  <div class="modal-content">
    <p id="confirmDeleteText"></p>
    <div class="mt-4">
      <button id="confirmDeleteBtn" class="bg-red-500 text-white px-6 py-2 rounded-md hover:bg-red-600">Yes, Delete</button>
      <button id="cancelDeleteBtn" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600">Cancel</button>
    </div>
  </div>
</div>

<!-- Add Child Modal -->
<div id="addChildModal" class="modal">
  <div class="modal-content">
    <h3 class="text-lg font-semibold mb-4">Add New Child Record</h3>
    <!-- Step 1: Basic Info -->
    <div id="addChildStep1">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left">
        <div>
          <label class="block text-sm font-medium mb-1">Name of Children:</label>
          <input type="text" id="newChildName" class="w-full p-2 border border-gray-300 rounded-md" required>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Age in Months:</label>
          <input type="number" id="newChildAge" min="0" class="w-full p-2 border border-gray-300 rounded-md" required>
        </div>
        <div class="relative">
          <label class="block text-sm font-medium mb-1">Date of Birth (mm/dd/yyyy):</label>
          <input type="date" id="newChildDob" class="w-full p-2 border border-gray-300 rounded-md" required>
        </div>
        <div>
          <label class="block text-sm font-medium mb-1">Name of Parent:</label>
          <input type="text" id="newChildParent" class="w-full p-2 border border-gray-300 rounded-md" required>
        </div>
        <div class="md:col-span-2 relative">
          <label class="block text-sm font-medium mb-1">Report Date (mm/yyyy):</label>
          <input type="month" id="newChildReportDate" class="w-full p-2 border border-gray-300 rounded-md" required>
        </div>
      </div>
    </div>

    <!-- Step 2: Vaccine Info -->
    <div id="addChildStep2" style="display: none;">
      <div id="vaccineInputsContainer" class="grid grid-cols-1 md:grid-cols-3 gap-x-6 gap-y-4 text-left max-h-64 overflow-y-auto pr-2">
        <!-- Vaccine inputs will be generated by JS -->
      </div>
    </div>

    <div class="mt-6">
      <button id="saveNewChildBtn" onclick="saveNewChild()" class="bg-primary text-white px-6 py-2 rounded-md hover:bg-secondary transition">Save Child</button>
      <button onclick="closeAddChildModal()" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600 transition">Cancel</button>
    </div>
  </div>
</div>

<script>
const BARANGAYS = ["Abiacao","Bagong Tubig","Balagtasin","Balite","Banoyo","Boboy","Bonliw","Calumpang East","Calumpang West","Dulangan","Durungao","Locloc","Luya","Mahabang Parang","Manggahan","Muzon","San Antonio","San Isidro","San Jose","San Martin","Santa Monica","Taliba","Talon","Tejero","Tungal","Poblacion"];
const SECTORS = ["Sector A", "Sector B", "Sector C"];
const YEARS = [2019, 2020, 2021, 2022, 2023, 2024, 2025];

const MONTHS = [{v:"01",l:"January"},{v:"02",l:"February"},{v:"03",l:"March"},{v:"04",l:"April"},{v:"05",l:"May"},{v:"06",l:"June"},{v:"07",l:"July"},{v:"08",l:"August"},{v:"09",l:"September"},{v:"10",l:"October"},{v:"11",l:"November"},{v:"12",l:"December"}];
// Get logged-in BHW's barangay and sector
const loggedInUser = JSON.parse(localStorage.getItem("loggedInUser") || "{}");
const bhwBarangay = loggedInUser.barangay;
const bhwSector = loggedInUser.sector;
const bhwEmail = loggedInUser.email; // Get BHW's email

// Load children data for this BHW
const childrenDataKey = `hp_children_${bhwBarangay}__${bhwSector}`;
let childrenData = JSON.parse(localStorage.getItem(childrenDataKey) || "[]");

// Populate filter selects
const yearContainer = document.getElementById('yearFilterContainer');
yearContainer.innerHTML = `
  <label class="flex items-center text-sm font-semibold">
    <input type="checkbox" name="year" value="all" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary">
    <span class="ml-2">Select All</span>
  </label>
`;
YEARS.forEach(y => {
  yearContainer.innerHTML += `
    <label class="flex items-center text-sm">
      <input type="checkbox" name="year" value="${y}" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary filter-option">
      <span class="ml-2">${y}</span>
    </label>
  `;
});

const monthContainer = document.getElementById('monthFilterContainer');
monthContainer.innerHTML = `
  <label class="flex items-center text-sm font-semibold">
    <input type="checkbox" name="month" value="all" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary">
    <span class="ml-2">Select All</span>
  </label>
`;
MONTHS.forEach(month => {
  monthContainer.innerHTML += `
    <label class="flex items-center text-sm">
      <input type="checkbox" name="month" value="${month.v}" class="h-4 w-4 rounded border-gray-300 text-primary focus:ring-primary filter-option">
      <span class="ml-2">${month.l}</span>
    </label>
  `;
});


let filteredData = childrenData; // for barangay/month filter

let isEditing = false;
let hasUnsavedChanges = false;
let backupData = null;
renderTable(filteredData);

// Upload Modal Logic
function openUploadModal() {
  const modal = document.getElementById('uploadModal');
  const yearSelect = document.getElementById('reportYearSelect');
  const monthSelect = document.getElementById('reportMonthSelect');
  const warningDiv = document.getElementById('uploadWarning');
  warningDiv.style.display = 'none';

  // Populate selects if empty
  if (yearSelect.options.length === 0) {
    YEARS.forEach(y => yearSelect.add(new Option(y, y)));
    MONTHS.forEach(m => monthSelect.add(new Option(m.l, m.v)));
  }

  // Set to current month/year
  const now = new Date();
  yearSelect.value = now.getFullYear();
  monthSelect.value = String(now.getMonth() + 1).padStart(2, '0');

  // Check for existing data for the selected period
  const checkExistingData = () => {
    const reportDate = `${monthSelect.value}/${yearSelect.value}`;
    const hasData = childrenData.some(c => c["Report Date"] === reportDate);
    if (hasData) {
      warningDiv.textContent = `Data for ${MONTHS.find(m=>m.v===monthSelect.value).l} ${yearSelect.value} already exists. Uploading will overwrite it.`;
      warningDiv.style.display = 'block';
    } else {
      warningDiv.style.display = 'none';
    }
  };

  yearSelect.onchange = checkExistingData;
  monthSelect.onchange = checkExistingData;
  checkExistingData(); // Initial check

  modal.style.display = 'block';
}

function closeUploadModal() {
  document.getElementById('uploadModal').style.display = 'none';
}


document.getElementById('fileInput').addEventListener('change', handleFile);

function updateButtonState() {
  const editBtn = document.getElementById('editBtn');
  const editActions = document.getElementById('editModeActions');

  if (isEditing) {
    editBtn.textContent = 'Cancel';
    editBtn.onclick = cancelEdit;
    editActions.style.display = 'flex';
  } else {
    editBtn.textContent = 'Edit';
    editBtn.onclick = toggleEditMode;
    editActions.style.display = 'none';
  }
}

function toggleEditMode() {
  isEditing = !isEditing;
  if (isEditing) {
    backupData = JSON.parse(JSON.stringify(childrenData)); // Deep copy for backup
  }
  updateButtonState();
  renderTable(filteredData);
}

function cancelEdit() {
  if (hasUnsavedChanges) {
    const modal = document.getElementById('confirmCancelModal');
    document.getElementById('confirmCancelText').textContent = "Are you sure you want to cancel? All unsaved changes will be lost.";
    document.getElementById('confirmCancelBtn').textContent = "Yes, Cancel";
    modal.style.display = 'block';
    // The actual cancellation logic is now handled by the modal's event listener
    return;
  }

  // If no unsaved changes, cancel immediately
  if (backupData) childrenData = JSON.parse(JSON.stringify(backupData));
  isEditing = false;
  hasUnsavedChanges = false;
  updateButtonState();
  renderTable(childrenData);
}

function normalizeVaccineValue(value){
  if(!value) return "Needed";
  value = value.toString().toLowerCase();
  return value === "accepted" ? "Accepted" : "Needed";
}

function handleFile(e) {
  const file = e.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  const reportYear = document.getElementById('reportYearSelect').value;
  const reportMonth = document.getElementById('reportMonthSelect').value;
  const reportDate = `${reportMonth}/${reportYear}`;
  const uploadTimestamp = new Date().toISOString();

reader.onload = e => {
  let data;
  if(file.name.toLowerCase().endsWith(".csv")){
    data = parseCSV(e.target.result);
  } else {
    const array = new Uint8Array(e.target.result);
    const workbook = XLSX.read(array,{type:'array'});
    const worksheet = workbook.Sheets[workbook.SheetNames[0]];
    data = XLSX.utils.sheet_to_json(worksheet,{defval:""});
  }

  if (data.length === 0) {
    alert("No data in file.");
    return;
  }

  const expectedHeaders = ["Name of Children", "Age in Months", "Date of Birth", "Name of Parent", "BCG (At Birth)", "HEPA B (At Birth)", "PENTA 1 ( 1 1/2 mos.)", "PENTA 2 ( 2 1/2 mos.)", "PENTA 3 ( 3 1/2 mos.)", "OPV 1  ( 1 1/2 mos.)", "OPV 2  ( 2 1/2 mos.)", "OPV 3  ( 3 1/2 mos.)", "IPV1  ( 3 1/2 mos.)", "IPV2  ( 9 mos.)", "PCV1  ( 1 1/2 mos.)", "PCV2  ( 2 1/2 mos.)", "PCV3  ( 3 1/2 mos.)", "MCV1 (9 mos.)", "MCV2 (12 mos. & 29 days)"];
  const fileHeaders = Object.keys(data[0]);
  const missing = expectedHeaders.filter(h => !fileHeaders.includes(h));
  if (missing.length > 0) {
    alert("Invalid file format. Missing columns: " + missing.join(", "));
    return;
  }

  // Remove any existing data for this report period
  childrenData = childrenData.filter(c => c["Report Date"] !== reportDate);

  data.forEach(row => {
    // Assign current BHW's barangay, sector, and email to imported children
    row["Barangay"] = bhwBarangay;
    row["Sector"] = bhwSector;
    row["bhwEmail"] = bhwEmail;
    row["Report Date"] = reportDate;
    row["Upload Date"] = uploadTimestamp;
  });

  childrenData = childrenData.concat(data);
  filteredData = childrenData; // Sync filtered data with the new master list
  saveAndRender();
  closeUploadModal();
  
  // Show success message
  const monthName = MONTHS.find(m => m.v === reportMonth).l;
  document.getElementById('infoModalText').textContent = `Successfully uploaded ${data.length} records for ${monthName} ${reportYear}.`;
  document.getElementById('infoModal').style.display = 'block';
};

  if(file.name.toLowerCase().endsWith(".csv")) reader.readAsText(file);
  else reader.readAsArrayBuffer(file);
}

function parseCSV(text){
  const lines=text.trim().split("\n");
  const headers=lines[0].split(",").map(h=>h.trim());
  return lines.slice(1).map(line=>{
    const values=line.split(",");
    return headers.reduce((obj, header,i)=>{
      obj[header]=values[i]?values[i].trim():"";
      return obj;
    },{});
  });
}

function renderVaccineCell(name,row){
  if (isEditing) {
    return `<td><input type="text" value="${row[name] || ''}" placeholder="mm/dd/yyyy" class="vaccine-date-input" style="width:80px; border:1px solid #ccc; padding:2px; border-radius:3px;"></td>`;
  } else {
    const val = row[name] && row[name].trim();
    const value = val ? row[name] : "Not Vaccinated";
    return `<td><span class="badge ${val?"vaccinated":"not-vaccinated"}">${value}</span></td>`;
  }
}

function formatReportDateForDisplay(reportDate) {
  if (!reportDate || !reportDate.includes('/')) return reportDate || '';
  const [month, year] = reportDate.split('/');
  const monthName = MONTHS.find(m => m.v === month)?.l || 'Unknown';
  return `${monthName} ${year}`;
}

function renderTable(dataToRender){
  const tbody = document.querySelector("#childrenTable tbody");
  tbody.innerHTML="";
  const data = dataToRender || childrenData;
  if (data.length === 0) {
    document.getElementById("noRecords").style.display = "block";
  } else {
    document.getElementById("noRecords").style.display = "none";
  }
  const selectAllTh = document.querySelector('#selectAll').parentElement;
  selectAllTh.style.display = isEditing ? '' : 'none';
  data.forEach((row,index)=>{
    const tr=document.createElement("tr");
    tr.dataset.index=index;
    if(row.newChild) tr.classList.add("new-child");
    tr.innerHTML=`
      <td style="display: ${isEditing ? '' : 'none'}"><input type="checkbox" class="select-row"></td>
      <td contenteditable="${isEditing}">${row["Name of Children"]||""}</td>
      <td contenteditable="${isEditing}">${row["Age in Months"]||""}</td>
      ${isEditing ? `<td><input type="text" value="${row["Date of Birth"] || ''}" placeholder="mm/dd/yyyy" class="vaccine-date-input" style="width:80px; border:1px solid #ccc; padding:2px; border-radius:3px;"></td>` : `<td>${row["Date of Birth"]||""}</td>`}
      <td contenteditable="${isEditing}">${row["Name of Parent"]||""}</td>
      <td>${formatReportDateForDisplay(row["Report Date"])}</td>
      ${renderVaccineCell("BCG (At Birth)", row)}
      ${renderVaccineCell("HEPA B (At Birth)", row)}
      ${renderVaccineCell("PENTA 1 ( 1 1/2 mos.)", row)}
      ${renderVaccineCell("PENTA 2 ( 2 1/2 mos.)", row)}
      ${renderVaccineCell("PENTA 3 ( 3 1/2 mos.)", row)}
      ${renderVaccineCell("OPV 1  ( 1 1/2 mos.)", row)}
      ${renderVaccineCell("OPV 2  ( 2 1/2 mos.)", row)}
      ${renderVaccineCell("OPV 3  ( 3 1/2 mos.)", row)}
      ${renderVaccineCell("IPV1  ( 3 1/2 mos.)", row)}
      ${renderVaccineCell("IPV2  ( 9 mos.)", row)}
      ${renderVaccineCell("PCV1  ( 1 1/2 mos.)", row)}
      ${renderVaccineCell("PCV2  ( 2 1/2 mos.)", row)}
      ${renderVaccineCell("PCV3  ( 3 1/2 mos.)", row)}
      ${renderVaccineCell("MCV1 (9 mos.)", row)}
      ${renderVaccineCell("MCV2 (12 mos. & 29 days)", row)}
    `;
    tbody.appendChild(tr);
  });
}

function editRow(button, index){
  if (childrenData[index].Barangay !== bhwBarangay || childrenData[index].Sector !== bhwSector) {
    alert("You can only edit records from your barangay and sector.");
    return;
  }
  const tr = button.closest("tr");
  const isEditing = button.innerText === "Save";
  if(isEditing){
    const cells = tr.querySelectorAll("td");
    const updated = {
      "Name": cells[0].innerText.trim(),
      "Age in Months": cells[1].innerText.trim(),
      "Date of Birth": cells[2].innerText.trim(),
      "Name of Parent": cells[3].innerText.trim(),
      "Barangay": cells[4].innerText.trim(),
      "Sector": cells[5].innerText.trim(),
      "BCG": cells[6].querySelector("button")?.innerText || "Needed",
      "HEPA B": cells[7].querySelector("button")?.innerText || "Needed",
      "PENTA 1": cells[8].querySelector("button")?.innerText || "Needed",
      "PENTA 2": cells[9].querySelector("button")?.innerText || "Needed",
      "PENTA 3": cells[10].querySelector("button")?.innerText || "Needed",
      "OPV1": cells[11].querySelector("button")?.innerText || "Needed",
      "OPV2": cells[12].querySelector("button")?.innerText || "Needed",
      "OPV3": cells[13].querySelector("button")?.innerText || "Needed",
      "IPV1": cells[14].querySelector("button")?.innerText || "Needed",
      "IPV2": cells[15].querySelector("button")?.innerText || "Needed",
      "PCV1": cells[16].querySelector("button")?.innerText || "Needed",
      "PCV2": cells[17].querySelector("button")?.innerText || "Needed",
      "PCV3": cells[18].querySelector("button")?.innerText || "Needed",
      "MCV1": cells[19].querySelector("button")?.innerText || "Needed",
      "MCV2": cells[20].querySelector("button")?.innerText || "Needed",
      "bhwEmail": bhwEmail
    };
    childrenData[index] = updated;
    localStorage.setItem(childrenDataKey, JSON.stringify(childrenData));
    renderTable();
  } else {
    tr.querySelectorAll("td").forEach((c, i) => {
      if(i >= 0 && i <= 5) c.contentEditable = true;
    });
    button.innerText = "Save";
  }
}

function confirmAddChild() {
    openAddChildModal();
}

function openAddChildModal() {
    document.getElementById('addChildModal').style.display = 'block';
    document.getElementById('addChildStep1').style.display = 'block';
    document.getElementById('addChildStep2').style.display = 'block';
    document.getElementById('saveNewChildBtn').style.display = 'inline-block';

    // Populate vaccine inputs if not already there
    const vaccineContainer = document.getElementById('vaccineInputsContainer');
    if (vaccineContainer.innerHTML === '') {
        const vaccineList = ["BCG (At Birth)", "HEPA B (At Birth)", "PENTA 1 ( 1 1/2 mos.)", "PENTA 2 ( 2 1/2 mos.)", "PENTA 3 ( 3 1/2 mos.)", "OPV 1  ( 1 1/2 mos.)", "OPV 2  ( 2 1/2 mos.)", "OPV 3  ( 3 1/2 mos.)", "IPV1  ( 3 1/2 mos.)", "IPV2  ( 9 mos.)", "PCV1  ( 1 1/2 mos.)", "PCV2  ( 2 1/2 mos.)", "PCV3  ( 3 1/2 mos.)", "MCV1 (9 mos.)", "MCV2 (12 mos. & 29 days)"];
        vaccineList.forEach(vaccine => {
            vaccineContainer.innerHTML += `
                <div class="relative">
                    <label class="block text-sm font-medium mb-1">${vaccine}:</label>
                    <input type="date" data-vaccine-name="${vaccine}" class="w-full p-2 border border-gray-300 rounded-md vaccine-date-input" placeholder="mm/dd/yyyy">
                </div>
            `;
        });
    }
}

function closeAddChildModal() {
    document.getElementById('addChildModal').style.display = 'none';
    // Clear fields on close
    document.getElementById('newChildName').value = '';
    document.getElementById('newChildAge').value = '';
    document.getElementById('newChildDob').value = '';
    document.getElementById('newChildParent').value = '';
    document.getElementById('newChildReportDate').value = '';
    document.querySelectorAll('#vaccineInputsContainer input').forEach(input => {
        input.value = '';
    });
}

function saveNewChild() {
    const name = document.getElementById('newChildName').value.trim();
    const age = document.getElementById('newChildAge').value.trim();
    const dob = formatDateFromPicker(document.getElementById('newChildDob').value);
    const parent = document.getElementById('newChildParent').value.trim();
    const reportDate = formatMonthFromPicker(document.getElementById('newChildReportDate').value);

    if (!name || !age || !dob || !parent || !reportDate) {
        alert("Please fill all required fields: Name, Age, DOB, Parent, and Report Date.");
        return;
    }
    if (!isValidDate(dob)) {
        alert(`Invalid Date of Birth format for "${name}". Please use mm/dd/yyyy.`);
        return;
    }
    if (!isValidReportDate(reportDate)) {
        alert(`Invalid Report Date format for "${name}". Please use mm/yyyy.`);
        return;
    }

    const newChild = {
        "Name of Children": name,
        "Age in Months": age,
        "Date of Birth": dob,
        "Name of Parent": parent,
        "Report Date": reportDate,
        "Barangay": bhwBarangay,
        "Sector": bhwSector,
        "bhwEmail": bhwEmail,
        "Upload Date": new Date().toISOString(),
        "newChild": true // Flag to highlight the new row
    };

    // Get vaccine dates
    document.querySelectorAll('#vaccineInputsContainer input').forEach(input => {
        const vaccineName = input.dataset.vaccineName;
        newChild[vaccineName] = formatDateFromPicker(input.value);
    });

    childrenData.push(newChild);
    hasUnsavedChanges = true;
    saveAndRender();
    closeAddChildModal();
}

/*
function editTable(){
  isEditing = true;
  const btn = document.getElementById("editTableBtn");
  btn.style.backgroundColor = "#28a745"; // green
  btn.style.color = "white";
  renderTable();
}
*/

function toggleVaccine(btn){
  if(btn.disabled) return;
  if(btn.innerText==="Needed"){
    btn.innerText="Accepted";
    btn.classList.remove("needed");
    btn.classList.add("accepted");
  } else {
    btn.innerText="Needed";
    btn.classList.remove("accepted");
    btn.classList.add("needed");
  }
}

function isValidDate(dateString) {
    // Checks for mm/dd/yyyy format and valid date
    if (!/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(dateString)) {
        return false;
    }
    const parts = dateString.split("/");
    const month = parseInt(parts[0], 10);
    const day = parseInt(parts[1], 10);
    const year = parseInt(parts[2], 10);
    if(year < 1900 || year > 2100 || month === 0 || month > 12) return false;
    const monthLength = [ 31, 28, 31, 30, 31, 30, 31, 31, 30, 31, 30, 31 ];
    if(year % 400 === 0 || (year % 100 !== 0 && year % 4 === 0)) monthLength[1] = 29;
    return day > 0 && day <= monthLength[month - 1];
}

function formatDateFromPicker(dateString) { // yyyy-mm-dd -> mm/dd/yyyy
    if (!dateString) return '';
    const [year, month, day] = dateString.split('-');
    return `${month}/${day}/${year}`;
}

function formatMonthFromPicker(monthString) { // yyyy-mm -> mm/yyyy
    if (!monthString) return '';
    const [year, month] = monthString.split('-');
    return `${month}/${year}`;
}


function isValidReportDate(dateString) {
    // Checks for mm/yyyy format
    if (!/^\d{2}\/\d{4}$/.test(dateString)) {
        return false;
    }
    const [month, year] = dateString.split("/");
    const monthNum = parseInt(month, 10);
    const yearNum = parseInt(year, 10);

    return monthNum >= 1 && monthNum <= 12 && YEARS.includes(yearNum);
}

function saveTableEdits(){
  const tbody=document.querySelector("#childrenTable tbody");
  const rows=tbody.querySelectorAll("tr:not(.new-child)"); // Exclude new child rows from this logic
  const newChildrenData=Array.from(rows).map(tr=>{
    const cells=tr.querySelectorAll("td");
    const getVaccineValue = (cell) => {
      const input = cell.querySelector('input');
      if (input) {
        return input.value.trim();
      } else {
        return cell.innerText.trim() === "Not Vaccinated" ? "" : cell.innerText.trim();
      }
    };

    const name = cells[1].innerText.trim();
    const age = cells[2].innerText.trim();
    const dob = cells[3].querySelector('input') ? cells[3].querySelector('input').value.trim() : cells[3].innerText.trim();
    const parent = cells[4].innerText.trim();
    if (!name || !age || !dob || !parent) {
      alert(`Please fill all required fields (Name, Age, DOB, Parent) for "${name || 'the new child'}".`);
      return 'error';
    }
    if (!isValidDate(dob)) {
      alert(`Invalid Date of Birth format for "${name}". Please use mm/dd/yyyy.`);
      return 'error';
    }

    const originalDataIndex = parseInt(tr.dataset.index, 10);
    const originalChild = filteredData[originalDataIndex] || {};

    const updatedChild = {
      ...originalChild, // Preserve existing fields like Report Date, Upload Date etc.
      "Name of Children":cells[1].innerText.trim(),
      "Age in Months":cells[2].innerText.trim(),
      "Date of Birth": dob,
      "Name of Parent":cells[4].innerText.trim(),
      // Note: Report Date (cells[5]) is not editable
      "BCG (At Birth)":getVaccineValue(cells[6]), // BCG starts at cell 6
      "HEPA B (At Birth)":getVaccineValue(cells[7]),
      "PENTA 1 ( 1 1/2 mos.)":getVaccineValue(cells[8]),
      "PENTA 2 ( 2 1/2 mos.)":getVaccineValue(cells[9]),
      "PENTA 3 ( 3 1/2 mos.)":getVaccineValue(cells[10]),
      "OPV 1  ( 1 1/2 mos.)":getVaccineValue(cells[11]),
      "OPV 2  ( 2 1/2 mos.)":getVaccineValue(cells[12]),
      "OPV 3  ( 3 1/2 mos.)":getVaccineValue(cells[13]),
      "IPV1  ( 3 1/2 mos.)":getVaccineValue(cells[14]),
      "IPV2  ( 9 mos.)":getVaccineValue(cells[15]),
      "PCV1  ( 1 1/2 mos.)":getVaccineValue(cells[16]),
      "PCV2  ( 2 1/2 mos.)":getVaccineValue(cells[17]),
      "PCV3  ( 3 1/2 mos.)":getVaccineValue(cells[18]),
      "MCV1 (9 mos.)":getVaccineValue(cells[19]),
      "MCV2 (12 mos. & 29 days)":getVaccineValue(cells[20]),
      "bhwEmail": bhwEmail // Ensure BHW email is saved with the child record
    };
    return updatedChild;
  });

  if (newChildrenData.some(c => c === 'error')) {
    return; // Stop the save process if there was a validation error
  }

  // Update the master childrenData array with the changes
  newChildrenData.forEach((updatedChild, i) => {
      const originalDataIndex = parseInt(rows[i].dataset.index, 10);
      const originalChild = filteredData[originalDataIndex];
      // Find the corresponding child in the main childrenData array and update it
      const masterIndex = childrenData.findIndex(child => child === originalChild);
      if (masterIndex !== -1) {
          childrenData[masterIndex] = updatedChild;
      }
  });

  localStorage.setItem(childrenDataKey, JSON.stringify(childrenData));
  isEditing = false;
  // Hide edit UI
  const editBtn = document.getElementById('editBtn');
  editBtn.textContent = 'Edit';
  editBtn.style.backgroundColor = '';
  document.querySelectorAll('.select-row, #selectAll').forEach(cb => cb.checked = false);
  
  filteredData = childrenData; // Reset filtered data to the new master list
  saveAndRender(); // This will re-render the table with the updated data
  hasUnsavedChanges = false;
  backupData = null;
  updateButtonState();

  // Use custom info modal for success message
  const modal = document.getElementById('infoModal');
  document.getElementById('infoModalText').textContent = "Changes saved successfully!";
  modal.style.display = 'block';
}

function deleteSelected(){
  const selectedIndexes=[];
  document.querySelectorAll("#childrenTable tbody tr").forEach((tr,index)=>{
    const checkbox = tr.querySelector(".select-row");
    if (checkbox && checkbox.checked) {
      selectedIndexes.push(parseInt(tr.dataset.index, 10));
    }    
  });
  if (selectedIndexes.length === 0) {
    const modal = document.getElementById('infoModal');
    document.getElementById('infoModalText').textContent = "No children selected!";
    modal.style.display = 'block';
    return;
  }

  const modal = document.getElementById('confirmDeleteModal');
  document.getElementById('confirmDeleteText').textContent = `Are you sure you want to delete ${selectedIndexes.length} selected record(s)?`;
  modal.style.display = 'block';

  document.getElementById('confirmDeleteBtn').onclick = () => {
    childrenData = childrenData.filter((_, index) => !selectedIndexes.includes(index));
    saveAndRender();
    hasUnsavedChanges = true;
    modal.style.display = 'none';
  };
  document.getElementById('cancelDeleteBtn').onclick = () => { modal.style.display = 'none'; };
}

function searchByName(){
  const term=document.getElementById("searchName").value.toLowerCase().trim();
  if(!term){ renderTable(filteredData); return; }
  const searched=filteredData.filter(c=> (c["Name of Children"]||"").toLowerCase().includes(term));
  renderTable(searched);
}

// Search behavior
const searchInput = document.getElementById('searchName');
const searchBtn = document.getElementById('searchBtn');

if (searchInput && searchBtn) {
  searchBtn.addEventListener('click', searchByName);

  searchInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter') {
      searchByName();
    }
  });

  searchInput.addEventListener('input', () => {
    const term = searchInput.value.toLowerCase().trim();
    if (!term) { renderTable(filteredData); return; }
    const searched = filteredData.filter(c => (c["Name of Children"]||"").toLowerCase().includes(term));
    renderTable(searched);
  });
}

function toggleFilterDropdown() {
  const d = document.getElementById('filterBar');
  d.style.display = d.style.display === 'block' ? 'none' : 'block';
}

function toggleDownloadDropdown() {
  const d = document.querySelector('.dropdown .dropdown-content');
  d.style.display = d.style.display === 'block' ? 'none' : 'block';
}

function updateReportTitle() {
  const reportDateTitle = document.getElementById('reportDateTitle');
  const selectedYear = document.getElementById('yearSelect').value;
  const selectedMonth = document.getElementById('monthSelect').value;

  if (selectedYear === 'all' && selectedMonth === 'all') {
    reportDateTitle.style.display = 'none';
  } else {
    const monthName = selectedMonth !== 'all' ? MONTHS.find(m => m.v === selectedMonth).l : '';
    const yearName = selectedYear !== 'all' ? selectedYear : '';
    let titleText = 'Displaying Report for:';
    
    if (monthName) titleText += ` ${monthName}`;
    if (yearName) titleText += ` ${yearName}`;

    reportDateTitle.textContent = titleText;
    reportDateTitle.style.display = 'block';
  }
}

function applyFilter() {
  const selectedYears = Array.from(document.querySelectorAll('#yearFilterContainer input:checked:not([value="all"])')).map(cb => cb.value);
  const selectedMonths = Array.from(document.querySelectorAll('#monthFilterContainer input:checked:not([value="all"])')).map(cb => cb.value);
  filteredData = childrenData.filter(child => {
    const yearMatch = selectedYears.length === 0;
    const monthMatch = selectedMonths.length === 0;

    if (yearMatch && monthMatch) return true;

    // Prioritize Report Date for filtering
    if (child["Report Date"]) {
      const [reportMonth, reportYear] = child["Report Date"].split('/');
      const yearMatches = yearMatch || selectedYears.includes(reportYear);
      const monthMatches = monthMatch || selectedMonths.includes(reportMonth);
      return yearMatches && monthMatches;
    }
    // Fallback for old data without Report Date (using DOB)
    const dob = child["Date of Birth"]; // e.g., "mm/dd/yyyy"
    if (dob && dob.includes('/')) {
      const [, month, year] = dob.split('/');
      const yearMatches = yearMatch || selectedYears.includes(year);
      const monthMatches = monthMatch || selectedMonths.includes(month);
      return yearMatches && monthMatches;
    }
    return false; // No date to filter by
  });
  renderTable(filteredData);
  updateReportTitle();
  toggleFilterDropdown();
}

function clearFilter() {
  document.querySelectorAll('#filterBar input[type="checkbox"]').forEach(cb => cb.checked = false);
  filteredData = childrenData;
  renderTable(filteredData);
  updateReportTitle();
  toggleFilterDropdown();
}

function saveAndRender(){
  localStorage.setItem(childrenDataKey,JSON.stringify(childrenData));
  renderTable(childrenData);
}

function downloadData(type){
  if(childrenData.length===0){alert("No data to download!");return;}
  if(type==="csv"){
    // Include bhwEmail in CSV export
    let csv=Object.keys(childrenData[0]).join(",")+"\n";
    childrenData.forEach(row=>csv+=Object.values(row).join(",")+"\n");
    const blob=new Blob([csv],{type:"text/csv"});
    const link=document.createElement("a");
    link.href=URL.createObjectURL(blob);
    link.download="children_report.csv";
    link.click();
  } else {
    const ws=XLSX.utils.json_to_sheet(childrenData);
    const wb=XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb,ws,"Report");
    XLSX.writeFile(wb,"children_report.xlsx");
  }
}

function toggleSelectAll(checkbox){
  document.querySelectorAll(".select-row").forEach(cb=>cb.checked=checkbox.checked);
}

function openTab(tabId, btn) {
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  document.getElementById(tabId).classList.add('active');
  btn.classList.add('active');
}

// Render BHW profile
function renderBHWProfile() {
  const user = JSON.parse(localStorage.getItem("loggedInUser") || "{}");
  document.getElementById("bhwName").textContent = user.name || "Placeholder BHW Name";
  document.getElementById("bhwEmail").textContent = user.email || "placeholder@bhw.com";
  document.getElementById("bhwBarangay").textContent = user.barangay || "All Barangays";
  document.getElementById("bhwSector").textContent = user.sector || "N/A";
}

const LS = { role: "hp_role", email: "hp_email", barangay: "hp_barangay", sector: "hp_sector" };

function logout() {
  document.getElementById('logoutModal').style.display = 'block';
}

// Render profile on load
renderBHWProfile();

function setupFilterCheckboxes(containerId) {
    const container = document.getElementById(containerId);
    if (!container) return;
    const selectAll = container.querySelector('input[value="all"]');
    const options = container.querySelectorAll('.filter-option');
    if (!selectAll) return;
    selectAll.addEventListener('change', () => {
        options.forEach(opt => opt.checked = selectAll.checked);
    });
}

document.addEventListener('DOMContentLoaded', function() {
  document.getElementById('confirmLogout').addEventListener('click', function() {
    localStorage.removeItem(LS.role);
    localStorage.removeItem(LS.email);
    localStorage.removeItem(LS.barangay);
    localStorage.removeItem(LS.sector);
    localStorage.removeItem("loggedInUser");
    window.location.href = 'index.html';
  });

  document.getElementById('proceedUploadBtn').addEventListener('click', function() {
    // Trigger the hidden file input
    document.getElementById('fileInput').click();
  });

  document.getElementById('cancelLogout').addEventListener('click', function() {
    document.getElementById('logoutModal').style.display = 'none';
  });

  // Other modal listeners can go here if needed

  // Setup "Select All" functionality for filters
  setupFilterCheckboxes('yearFilterContainer');
  setupFilterCheckboxes('monthFilterContainer');

  // Add event listener for the save new child button
  // document.getElementById('saveNewChildBtn').addEventListener('click', saveNewChild);
  // Using onclick in the HTML for simplicity as with other buttons.

});


</script>

<!-- Logout Modal -->
<div id="logoutModal" class="modal">
  <div class="modal-content">
    <p>Are you sure you want to log out?</p>
    <button id="confirmLogout" class="bg-red-500 text-white px-6 py-2 rounded-md hover:bg-red-600">Yes</button>
    <button id="cancelLogout" class="bg-gray-500 text-white px-6 py-2 rounded-md hover:bg-gray-600">No</button>
  </div>
</div>

</body>
</html>